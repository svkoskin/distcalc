<!DOCTYPE html>
<html>
<head>
<title>Calculator</title>
</head>

<body>
<script type="text/javascript" src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.0.min.js"></script>

<script type="text/javascript">
var illegals = new RegExp("[^0123456789\+\*\/\\-\.]", "g");
var firstRunMatcher = new RegExp("(\\d+)([\-\+\*\/])(\\d+)(.*)");
var normalMatcher = new RegExp("([\-\+\*\/])(\\d+)(.*)");

function doRequestCalculations(prevRes, expr, resultHandler) {
    var arg1, arg2, op, matches;

    expr = expr.replace(illegals, "");

    if (expr.length == 0) {
	// Wow we're so done
	resultHandler([]);
    }

    if (prevRes == null) {
	matches = expr.match(firstRunMatcher);

	arg1 = matches[1];
	op = matches[2];
	arg2 = matches[3];
	remainingExpr = matches[4];	
    } else { 
	matches = expr.match(normalMatcher);

	arg1 = prevRes;
	op = matches[1];
	arg2 = matches[2];
	remainingExpr = matches[3];
    }

    $.getJSON("/do_calculation.json", {
	arg1: arg1,
	arg2: arg2,
	op: op
    }, function(data) {
	var nextPrevRes = data.calcResult;

	if (data.errors.length > 0) {
	    // Wow we're giving up
	    resultHandler(data.errors);
	} else {
	    // Wo we'll go deeper
	    doRequestCalculations(nextPrevRes, remainingExpr, resultHandler);
	}
    });
}

function doRequestSine(expr) {
    var arg = expr.match(new RegExp("[\\d\.]+"))[0];
    
    $("#lastSine").html("<img src='/sin.png?arg=" + arg + "' />");
}

function requestCalculation() {
    var expr = $("input[name='expr']").val();

    if (expr.startsWith("sin")) {
	doRequestSine(expr);
    } else {
	doRequestCalculations(null, expr, function(errors) {
	    $.each(errors, function(idx, error) {
		$("#errors").append("<li>" + error + "</li>");
	    });

	    if (errors.length == 0) {
		updateCalculations();
	    }
	});
    }   
}

function updateCalculations() {
    $.getJSON("/calculations.json", function(data) {
	var newResults = "";
	
	$.each(data.results, function(idx, result) {
	    newResults = ("<li>" + result + "</li>") + newResults;
	});
	
	$("#results").html(newResults);
    });
}

$(function() {
    updateCalculations();

    $("#calcForm").submit(function(event) {
	event.preventDefault();
	requestCalculation();
    });
});

</script>

<ul id="errors"></ul>

<form id="calcForm">
  <input name="expr" type="text" />
  <input type="submit" name="submitCalc" value="calc" />
</form>

<div id="lastSine"></div>

<ul id="results"></ul>

</body>
</html>
